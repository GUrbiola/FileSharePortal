@using System.Web.Optimization;
@using System.Configuration;
@using FileSharePortal.Services;

@{
    var themeService = new ThemeService();
    var siteSettings = themeService.GetSiteSettings();
    var activeTheme = themeService.GetActiveTheme();
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - @siteSettings.SiteName</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    @* SweetAlert2 *@
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    @* Favicon *@
    @if (!string.IsNullOrEmpty(siteSettings.FaviconPath))
    {
        <link rel="icon" type="image/x-icon" href="@String.Concat(Settings.BaseUrl, siteSettings.FaviconPath)">
    }
    else
    {
        <link rel="icon" type="image/x-icon" href="@String.Concat(Settings.BaseUrl,"/Content/images/favicon.ico")">
    }

    @* Dynamic Theme CSS *@
    <link rel="stylesheet" href="@Url.Action("GetCss", "Theme")" />

    @RenderSection("styles", required: false)
</head>
<body>
    @if (User.Identity.IsAuthenticated)
    {
        var currentUser = ViewBag.CurrentUser as FileSharePortal.Models.User;

        <!-- Top Header Bar -->
        <nav class="top-header navbar navbar-dark bg-primary">
            <div class="container-fluid">
                <button class="btn btn-link text-white sidebar-toggle" id="sidebarToggle">
                    <i class="bi bi-list" style="font-size: 1.5rem;"></i>
                </button>
                <a class="navbar-brand" href="@Url.Action("Index", "Home")">
                    @if (!string.IsNullOrEmpty(siteSettings.LogoPath))
                    {
                        <img src="@String.Concat(Settings.BaseUrl, siteSettings.LogoPath)" alt="@siteSettings.SiteName" style="height: 35px; width: auto; margin-right: 10px;margin-bottom:10px;">
                    }
                    else
                    {
                        <i class="bi bi-cloud-upload"></i>
                    }
                    @siteSettings.SiteName
                </a>
                <ul class="navbar-nav ms-auto d-flex flex-row align-items-center">
                    <li class="nav-item me-3">
                        @if (Settings.ShowNotificationsSection)
                        {
                            <a class="nav-link position-relative" href="@Url.Action("Index", "Notifications")">
                                <i class="bi bi-bell" style="font-size: 1.2rem;"></i>
                                <span class="notification-badge" id="notificationCount" style="display:none;">0</span>
                            </a>
                        }
                        else
                        {
                            <a class="nav-link position-relative" href="#">
                                <i class="bi bi-bell" style="font-size: 1.2rem;"></i>
                                <span class="notification-badge" id="notificationCount" style="display:none;">0</span>
                            </a>
                        }
                        </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> @(currentUser != null ? currentUser.FullName : User.Identity.Name)
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            @if (Settings.ShowNotificationsSection)
                            {
                                <li>
                                    <a class="dropdown-item" href="@Url.Action("Index", "Notifications")">
                                        <i class="bi bi-bell"></i>
                                        Notifications
                                    </a>
                                </li>

                            }
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form method="post" action="@Url.Action("Logout", "Account")" style="display:inline;">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="dropdown-item">
                                        <i class="bi bi-box-arrow-right"></i> Logout
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Sidebar Navigation -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h5>Navigation</h5>
            </div>
            <nav class="sidebar-nav">
                <a id="HomeLink" href="@Url.Action("Index", "Home")" class="sidebar-link">
                    <i class="bi bi-house-door"></i>
                    <span>Home</span>
                </a>
                <a id="FilesLink" href="@Url.Action("Index", "Files")" class="sidebar-link">
                    <i class="bi bi-folder"></i>
                    <span>My Files</span>
                </a>
                <a id="SharedWithMeLink" href="@Url.Action("SharedWithMe", "Files")" class="sidebar-link">
                    <i class="bi bi-share"></i>
                    <span>Shared With Me</span>
                </a>
                <a id="UploadLink" href="@Url.Action("Upload", "Files")" class="sidebar-link">
                    <i class="bi bi-upload"></i>
                    <span>Upload File</span>
                </a>

                @if (Settings.ShowApplicationsSection)
                {
                    <a id="ApplicationsLink" href="@Url.Action("Index", "Applications")" class="sidebar-link">
                        <i class="bi bi-grid"></i>
                        <span>Applications</span>
                    </a>
                }

                @if (currentUser != null && currentUser.IsAdmin && Settings.ShowAdminSection)
                {
                    <div class="sidebar-divider"></div>
                    <div class="sidebar-section-title">Administration</div>

                    <a id="AdminDashBoardLink" href="@Url.Action("Index", "Admin")" class="sidebar-link">
                        <i class="bi bi-speedometer2"></i>
                        <span>Admin Dashboard</span>
                    </a>
                    <a id="UsersLink" href="@Url.Action("Users", "Admin")" class="sidebar-link">
                        <i class="bi bi-people"></i>
                        <span>Users</span>
                    </a>
                    <a id="RolesLink" href="@Url.Action("Roles", "Admin")" class="sidebar-link">
                        <i class="bi bi-diagram-3"></i>
                        <span>Roles</span>
                    </a>
                    <a id="DistListLink" href="@Url.Action("DistributionLists", "Admin")" class="sidebar-link">
                        <i class="bi bi-list-ul"></i>
                        <span>Distribution Lists</span>
                    </a>
                    <a id="FilesAdminLink" href="@Url.Action("Files", "Admin")" class="sidebar-link">
                        <i class="bi bi-folder-symlink"></i>
                        <span>All Files</span>
                    </a>
                    <a id="FilesReportedLink" href="@Url.Action("Reports", "Admin")" class="sidebar-link">
                        <i class="bi bi-flag"></i>
                        <span>File Reports</span>
                    </a>

                    @* Error Logs link - only for debug admin *@
                    {
                        var debugAdminUsername = ConfigurationManager.AppSettings["DebugAdminUsername"];
                        var isDebugAdmin = !string.IsNullOrWhiteSpace(debugAdminUsername) &&
                                          currentUser.Username.Equals(debugAdminUsername, StringComparison.OrdinalIgnoreCase);
                        if (isDebugAdmin)
                        {
                            <a id="ErrorLogsLink" href="@Url.Action("Index", "ErrorLogs")" class="sidebar-link">
                                <i class="bi bi-bug"></i>
                                <span>Error Logs</span>
                            </a>
                        }
                    }

                    if (Settings.ShowAppearanceSection)
                    {
                        <div class="sidebar-divider"></div>
                        <div class="sidebar-section-title">Appearance</div>

                        <a id="ThemesLink" href="@Url.Action("Index", "Theme")" class="sidebar-link">
                            <i class="bi bi-palette"></i>
                            <span>Themes</span>
                        </a>
                        <a id="SiteSettingsLink" href="@Url.Action("SiteSettings", "Theme")" class="sidebar-link">
                            <i class="bi bi-gear-fill"></i>
                            <span>Site Settings</span>
                        </a>
                    }
                }
            </nav>
        </div>

        <!-- Sidebar Overlay for mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Content Area -->
        <div class="main-content" id="mainContent">
            <div class="container-fluid">
                @if (TempData["Success"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle"></i> @TempData["Success"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }
                @if (TempData["Error"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> @TempData["Error"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                @RenderBody()
            </div>

            <footer>
                <div class="container-fluid text-center">
                    @*<p class="mb-0">&copy; @DateTime.Now.Year File Share Portal. All rights reserved.</p>*@
                </div>
            </footer>
        </div>
    }
    else
    {
        <!-- Non-authenticated content -->
        @RenderBody()
    }

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    @if (User.Identity.IsAuthenticated)
    {
        <script>
            $(document).ready(function () {
                // Sidebar toggle functionality
                var sidebar = $('#sidebar');
                var mainContent = $('#mainContent');
                var overlay = $('#sidebarOverlay');
                var sidebarToggle = $('#sidebarToggle');

                // Check if sidebar state is saved in localStorage
                var sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
                if (sidebarCollapsed) {
                    sidebar.addClass('collapsed');
                    mainContent.addClass('sidebar-collapsed');
                }

                // Toggle sidebar
                sidebarToggle.on('click', function () {
                    if ($(window).width() <= 768) {
                        // Mobile: Toggle active class and overlay
                        sidebar.toggleClass('active');
                        overlay.toggleClass('active');
                    } else {
                        // Desktop: Toggle collapsed state
                        sidebar.toggleClass('collapsed');
                        mainContent.toggleClass('sidebar-collapsed');

                        // Save state
                        localStorage.setItem('sidebarCollapsed', sidebar.hasClass('collapsed'));
                    }
                });

                // Close sidebar when clicking overlay (mobile)
                overlay.on('click', function () {
                    sidebar.removeClass('active');
                    overlay.removeClass('active');
                });

                // Handle window resize
                $(window).on('resize', function () {
                    if ($(window).width() <= 768) {
                        sidebar.removeClass('collapsed');
                        mainContent.removeClass('sidebar-collapsed');
                        overlay.removeClass('active');
                        sidebar.removeClass('active');
                    } else {
                        // Restore saved state on desktop
                        var sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
                        if (sidebarCollapsed) {
                            sidebar.addClass('collapsed');
                            mainContent.addClass('sidebar-collapsed');
                        } else {
                            sidebar.removeClass('collapsed');
                            mainContent.removeClass('sidebar-collapsed');
                        }
                    }
                });

                // Active link highlighting
                var currentPath = window.location.pathname;
                $('.sidebar-link').each(function () {
                    var linkPath = $(this).attr('href');
                    if (linkPath && currentPath.indexOf(linkPath) !== -1 && linkPath !== '/') {
                        $(this).addClass('active');
                    }
                });

                // Update notification count
                function updateNotificationCount() {
                    $.getJSON('@Url.Action("GetUnreadCount", "Notifications")', function (data) {
                        if (data.count > 0) {
                            $('#notificationCount').text(data.count).show();
                        } else {
                            $('#notificationCount').hide();
                        }
                    });
                }

                updateNotificationCount();
                setInterval(updateNotificationCount, 30000); // Update every 30 seconds
            });
        </script>
    }

    @RenderSection("scripts", required: false)
</body>
</html>
