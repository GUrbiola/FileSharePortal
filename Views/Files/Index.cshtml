@using System.Web.Optimization;

@model List<FileSharePortal.Models.SharedFile>
@{
    ViewBag.Title = "My Files";
}

<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="bi bi-folder"></i> My Files</h1>
        <p class="text-muted">Manage your uploaded files</p>
    </div>
    <div>
        <a href="@Url.Action("Upload", "Files")" class="btn btn-primary">
            <i class="bi bi-upload"></i> Upload New File
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        @if (Model != null && Model.Any())
        {
            <div class="row mb-3">
                <div class="col-md-6">
                    <input type="text" id="filterFileName" class="form-control" placeholder="Filter by file name or description...">
                </div>
                <div class="col-md-3">
                    <input type="date" id="filterDateFrom" class="form-control" placeholder="From date">
                </div>
                <div class="col-md-3">
                    <input type="date" id="filterDateTo" class="form-control" placeholder="To date">
                </div>
            </div>
            <div class="mb-2">
                <small class="text-muted">Showing <span id="resultCount">@Model.Count</span> of @Model.Count files</small>
            </div>
            <div class="table-responsive">
                <table class="table table-hover" id="filesTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="filename" style="cursor: pointer;">
                                File Name <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="size" style="cursor: pointer;">
                                Size <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="date" style="cursor: pointer;">
                                Uploaded Date <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="downloads" style="cursor: pointer;">
                                Downloads <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var file in Model)
                        {
                            <tr data-filename="@file.FileName.ToLower()"
                                data-description="@(String.IsNullOrEmpty(file.Description) ? "" : file.Description)"
                                data-uploaded="@file.UploadedDate.ToString("yyyy-MM-dd")"
                                data-size="@file.FileSize"
                                data-downloads="@file.DownloadCount"
                                data-uploaded-timestamp="@((file.UploadedDate - new DateTime(1970, 1, 1)).TotalMilliseconds)">
                                <td>
                                    <i class="bi bi-file-earmark text-primary"></i>
                                    <strong>@file.FileName</strong>
                                    @if (!string.IsNullOrEmpty(file.Description))
                                    {
                                        <br />
                                        <small class="text-muted">@file.Description</small>
                                    }
                                </td>
                                <td>@String.Format("{0:0.00} MB", file.FileSize / 1048576.0)</td>
                                <td>@file.UploadedDate.ToString("MMM dd, yyyy HH:mm")</td>
                                <td><span class="badge bg-info">@file.DownloadCount</span></td>
                                <td class="table-actions">
                                    <a href="@Url.Action("Details", new { id = file.FileId })" class="btn btn-sm btn-outline-primary" title="Details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="@Url.Action("Share", new { id = file.FileId })" class="btn btn-sm btn-outline-success" title="Share">
                                        <i class="bi bi-share"></i>
                                    </a>
                                    <a href="@Url.Action("Download", new { id = file.FileId })" class="btn btn-sm btn-outline-info" title="Download">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteFile(@file.FileId, '@file.FileName.Replace("'", "\\'")') " title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="bi bi-folder-x" style="font-size: 4rem; color: #ccc;"></i>
                <h3 class="mt-3">No Files Yet</h3>
                <p class="text-muted">Upload your first file to get started</p>
                <a href="@Url.Action("Upload")" class="btn btn-primary mt-3">
                    <i class="bi bi-upload"></i> Upload File
                </a>
            </div>
        }
    </div>
</div>
@section scripts {
    <script>
        var currentSort = { column: null, ascending: true };

        $(document).ready(function ()
        {
            $('.sidebar-link').removeClass('active');
            $('#FilesLink').addClass('active');

            // Filter functionality
            $('#filterFileName, #filterDateFrom, #filterDateTo').on('input change', function () {
                filterTable();
            });

            // Sorting functionality
            $('.sortable').on('click', function () {
                var sortColumn = $(this).data('sort');
                sortTable(sortColumn);
            });
        });

        function sortTable(column) {
            var tbody = $('#filesTable tbody');
            var rows = tbody.find('tr').toArray();

            // Toggle sort direction if same column, else default to ascending
            if (currentSort.column === column) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = column;
                currentSort.ascending = true;
            }

            // Sort rows
            rows.sort(function (a, b) {
                var aVal, bVal;

                switch (column) {
                    case 'filename':
                        aVal = $(a).data('filename');
                        bVal = $(b).data('filename');
                        break;
                    case 'size':
                        aVal = parseFloat($(a).data('size'));
                        bVal = parseFloat($(b).data('size'));
                        break;
                    case 'date':
                        aVal = parseFloat($(a).data('uploaded-timestamp'));
                        bVal = parseFloat($(b).data('uploaded-timestamp'));
                        break;
                    case 'downloads':
                        aVal = parseInt($(a).data('downloads'));
                        bVal = parseInt($(b).data('downloads'));
                        break;
                }

                if (aVal < bVal) return currentSort.ascending ? -1 : 1;
                if (aVal > bVal) return currentSort.ascending ? 1 : -1;
                return 0;
            });

            // Reorder rows in DOM
            $.each(rows, function (index, row) {
                tbody.append(row);
            });

            // Update sort icons
            $('.sortable .sort-icon').removeClass('bi-chevron-up bi-chevron-down').addClass('bi-chevron-expand');
            var activeHeader = $('.sortable[data-sort="' + column + '"]');
            var icon = activeHeader.find('.sort-icon');
            icon.removeClass('bi-chevron-expand');
            icon.addClass(currentSort.ascending ? 'bi-chevron-up' : 'bi-chevron-down');
        }

        function filterTable() {
            var fileNameFilter = $('#filterFileName').val().toLowerCase();
            var dateFromFilter = $('#filterDateFrom').val();
            var dateToFilter = $('#filterDateTo').val();

            var visibleCount = 0;

            $('#filesTable tbody tr').each(function () {
                var row = $(this);
                var fileName = row.data('filename');
                var description = row.data('description');
                var uploadedDate = row.data('uploaded');

                var showRow = true;

                // Filter by file name or description
                if (fileNameFilter && !fileName.includes(fileNameFilter) && !description.includes(fileNameFilter)) {
                    showRow = false;
                }

                // Filter by date range
                if (dateFromFilter && uploadedDate < dateFromFilter) {
                    showRow = false;
                }
                if (dateToFilter && uploadedDate > dateToFilter) {
                    showRow = false;
                }

                if (showRow) {
                    row.show();
                    visibleCount++;
                } else {
                    row.hide();
                }
            });

            $('#resultCount').text(visibleCount);
        }

        function deleteFile(fileId, fileName) {
            if (!confirm('Are you sure you want to delete "' + fileName + '"?\n\nThis action cannot be undone. All users who have access to this file will be notified.')) {
                return;
            }

            $.post('@Url.Action("Delete")', { id: fileId }, function (data) {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            }).fail(function (xhr, status, error) {
                alert('Error deleting file: ' + error);
            });
        }
    </script>
}
