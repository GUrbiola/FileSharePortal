@using System.Web.Optimization;

@model FileSharePortal.Models.Application
@{
    ViewBag.Title = "Application Details";
    var executions = ViewBag.Executions as List<FileSharePortal.Models.ApplicationExecution>;
}

<div class="page-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Home</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("Index")">Applications</a></li>
            <li class="breadcrumb-item active">@Model.ApplicationName</li>
        </ol>
    </nav>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-info-circle"></i> Application Information</span>
                <div class="app-status-badge">
                    <span class="status-indicator @Model.CurrentStatus.ToString().ToLower()"></span>
                    <span class="badge @(Model.CurrentStatus == FileSharePortal.Models.ApplicationStatus.Running ? "bg-success" : Model.CurrentStatus == FileSharePortal.Models.ApplicationStatus.Error ? "bg-danger" : "bg-secondary")">
                        @Model.CurrentStatus
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Application Name:</strong></div>
                    <div class="col-sm-8">@Model.ApplicationName</div>
                </div>
                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>Description:</strong></div>
                        <div class="col-sm-8">@Model.Description</div>
                    </div>
                }
                @if (!string.IsNullOrEmpty(Model.StatusEndpoint))
                {
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>Status Endpoint:</strong></div>
                        <div class="col-sm-8"><code>@Model.StatusEndpoint</code></div>
                    </div>
                }
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Check Interval:</strong></div>
                    <div class="col-sm-8">@Model.CheckIntervalMinutes minutes</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Last Status Check:</strong></div>
                    <div class="col-sm-8">
                        @if (Model.LastStatusCheck.HasValue)
                        {
                            @Model.LastStatusCheck.Value.ToString("MMMM dd, yyyy HH:mm:ss")
                        }
                        else
                        {
                            <span class="text-muted">Never</span>
                        }
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Last Successful Run:</strong></div>
                    <div class="col-sm-8">
                        @if (Model.LastSuccessfulRun.HasValue)
                        {
                            @Model.LastSuccessfulRun.Value.ToString("MMMM dd, yyyy HH:mm:ss")
                        }
                        else
                        {
                            <span class="text-muted">Never</span>
                        }
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Active:</strong></div>
                    <div class="col-sm-8">
                        @if (Model.IsActive)
                        {
                            <i class="bi bi-check-circle text-success"></i> <span class="text-success">Yes</span>
                        }
                        else
                        {
                            <i class="bi bi-x-circle text-danger"></i> <span class="text-danger">No</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Recent Execution History
            </div>
            <div class="card-body">
                @if (executions != null && executions.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Records</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var execution in executions)
                                {
                                    <tr>
                                        <td>@execution.StartTime.ToString("MMM dd HH:mm:ss")</td>
                                        <td>
                                            @if (execution.EndTime.HasValue)
                                            {
                                                @execution.EndTime.Value.ToString("MMM dd HH:mm:ss")
                                            }
                                            else
                                            {
                                                <span class="text-muted">Running...</span>
                                            }
                                        </td>
                                        <td>
                                            @if (execution.EndTime.HasValue)
                                            {
                                                var duration = execution.EndTime.Value - execution.StartTime;
                                                @String.Format("{0}m {1}s", (int)duration.TotalMinutes, duration.Seconds)
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @switch (execution.Status)
                                            {
                                                case FileSharePortal.Models.ApplicationStatus.Running:
                                                    <span class="badge bg-success">Running</span>
                                                    break;
                                                case FileSharePortal.Models.ApplicationStatus.Stopped:
                                                    <span class="badge bg-secondary">Stopped</span>
                                                    break;
                                                case FileSharePortal.Models.ApplicationStatus.Error:
                                                    <span class="badge bg-danger">Error</span>
                                                    break;
                                                default:
                                                    <span class="badge bg-secondary">@execution.Status</span>
                                                    break;
                                            }
                                        </td>
                                        <td>
                                            @if (execution.RecordsProcessed.HasValue)
                                            {
                                                <span class="badge bg-info">@execution.RecordsProcessed.Value</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted text-center py-4">No execution history available</p>
                }
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightning"></i> Actions
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" onclick="checkStatus()">
                        <i class="bi bi-arrow-clockwise"></i> Check Status Now
                    </button>
                    @if (!string.IsNullOrEmpty(Model.LogPath))
                    {
                        <a href="@Url.Action("DownloadLog", new { id = Model.ApplicationId })" class="btn btn-outline-secondary">
                            <i class="bi bi-download"></i> Download Log
                        </a>
                    }
                    @if (ViewBag.CurrentUser != null && ViewBag.CurrentUser.IsAdmin)
                    {
                        <a href="@Url.Action("Edit", new { id = Model.ApplicationId })" class="btn btn-outline-primary">
                            <i class="bi bi-pencil"></i> Edit Application
                        </a>
                        <button type="button" class="btn btn-outline-danger" onclick="deleteApplication()">
                            <i class="bi bi-trash"></i> Delete Application
                        </button>
                    }
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Applications
                    </a>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Statistics
            </div>
            <div class="card-body">
                @if (executions != null && executions.Any())
                {
                    var successCount = executions.Count(e => e.Status == FileSharePortal.Models.ApplicationStatus.Running);
                    var errorCount = executions.Count(e => e.Status == FileSharePortal.Models.ApplicationStatus.Error);
                    var successRate = executions.Count > 0 ? (successCount * 100.0 / executions.Count) : 0;

                    <p><strong>Total Executions:</strong> @executions.Count</p>
                    <p><strong>Successful:</strong> <span class="text-success">@successCount</span></p>
                    <p><strong>Errors:</strong> <span class="text-danger">@errorCount</span></p>
                    <p><strong>Success Rate:</strong> @String.Format("{0:0.0}%", successRate)</p>
                }
                else
                {
                    <p class="text-muted">No statistics available</p>
                }
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        function checkStatus() {
            $.post('@Url.Action("CheckStatus")', { id: @Model.ApplicationId }, function (data) {
                if (data.success) {
                    location.reload();
                }
            });
        }

        function deleteApplication() {
            if (!confirm('Are you sure you want to delete this application?\n\nThis will permanently delete:\n- The application configuration\n- All execution history\n- All log files\n- All API tokens\n\nThis action cannot be undone.')) {
                return;
            }

            $.post('@Url.Action("Delete")', { id: @Model.ApplicationId }, function (data) {
                if (data.success) {
                    alert(data.message);
                    window.location.href = '@Url.Action("Index")';
                } else {
                    alert('Error: ' + data.message);
                }
            }).fail(function (xhr, status, error) {
                alert('Error deleting application: ' + error);
            });
        }
    </script>
}
